<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monorepos are doo-doo</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --fg: #33ff33;
            --accent: #7ba1c7;
            --secondary: #1a1a1a;
            --text: #e0e0e0;
            --font-mono: "JetBrains Mono", "Fira Code", "Cascadia Code", "Courier New", monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::selection {
            background: var(--accent);
            color: var(--bg);
        }

        body {
            font-family: var(--font-mono);
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 3rem;
            border-bottom: 1px solid var(--fg);
            padding-bottom: 1rem;
            position: relative;
        }

        header::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, var(--fg), transparent);
        }

        h1 {
            font-size: 1.8rem;
            color: var(--fg);
            margin-bottom: 1rem;
            position: relative;
        }

        h1::before {
            content: ">";
            color: var(--accent);
            margin-right: 0.5rem;
            opacity: 0.7;
        }

        h2 {
            font-size: 1.4rem;
            color: var(--fg);
            margin: 2rem 0 1rem 0;
            position: relative;
        }

        h2::before {
            content: "//";
            color: var(--accent);
            margin-right: 0.5rem;
            font-size: 1rem;
            opacity: 0.7;
        }

        h3 {
            font-size: 1.2rem;
            color: var(--accent);
            margin: 1.5rem 0 1rem 0;
        }

        .metadata {
            color: var(--accent);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        p {
            margin-bottom: 1.5rem;
        }

        code {
            font-family: var(--font-mono);
            background: var(--secondary);
            padding: 0.2rem 0.4rem;
            color: var(--accent);
            border-radius: 3px;
        }

        pre {
            background: var(--secondary);
            padding: 1.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
            border-left: 2px solid var(--fg);
            position: relative;
        }

        pre::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, var(--fg), transparent);
        }

        pre code {
            background: none;
            padding: 0;
        }

        .tags {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            display: inline-block;
            padding: 0.2rem 0.8rem;
            background: var(--secondary);
            border: 1px solid var(--accent);
            font-size: 0.8rem;
            color: var(--accent);
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .tag:hover {
            background: var(--accent);
            color: var(--bg);
        }

        a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px dashed var(--accent);
            transition: all 0.2s ease;
        }

        a:hover {
            color: var(--fg);
            border-bottom: 1px solid var(--fg);
        }

        ul, ol {
            margin: 0 0 1.5rem 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        blockquote {
            border-left: 2px solid var(--accent);
            padding-left: 1rem;
            margin: 1.5rem 0;
            color: var(--accent);
            font-style: italic;
        }

        hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, var(--fg), transparent);
            margin: 2rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        th, td {
            padding: 0.5rem;
            border: 1px solid var(--secondary);
            text-align: left;
        }

        th {
            background: var(--secondary);
            color: var(--accent);
        }

        .post-navigation {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid var(--secondary);
            display: flex;
            justify-content: space-between;
        }

        .terminal-cursor::after {
            content: "▋";
            color: var(--fg);
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.2rem;
            }

            pre {
                padding: 1rem;
            }

            .tags {
                flex-direction: column;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            pre, code {
                background: #f0f0f0;
                border: 1px solid #ddd;
            }

            a {
                color: #0066cc;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="/">Home</a>
        </nav>
    </header>

    <main>
        
<style>
    .post-header {
        margin-bottom: 3rem;
        padding: 1.5rem;
        background: var(--secondary);
        border-left: 2px solid var(--fg);
        position: relative;
    }

    .post-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(90deg, var(--fg), transparent);
    }

    .post-meta {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: var(--accent);
    }

    .post-meta-item {
        display: inline-block;
        margin-right: 2rem;
    }

    .post-meta-item::before {
        content: ">";
        color: var(--fg);
        margin-right: 0.5rem;
    }

    .post-content {
        position: relative;
    }

    .post-content h1::before,
    .post-content h2::before,
    .post-content h3::before {
        color: var(--accent);
        margin-right: 0.5rem;
        opacity: 0.7;
    }

    .post-content h1::before { content: "#"; }
    .post-content h2::before { content: "##"; }
    .post-content h3::before { content: "###"; }

    .line-numbers {
        position: absolute;
        left: -3rem;
        color: var(--accent);
        opacity: 0.5;
        user-select: none;
        text-align: right;
        width: 2rem;
    }

    .terminal-window {
        background: var(--secondary);
        margin: 2rem 0;
        border: 1px solid var(--accent);
        border-radius: 5px;
    }

    .terminal-header {
        padding: 0.5rem;
        background: var(--accent);
        color: var(--bg);
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
    }

    .terminal-body {
        padding: 1rem;
        position: relative;
    }

    .terminal-body pre {
        margin: 0;
        border-left: none;
    }

    .terminal-body pre::before {
        display: none;
    }

    .copy-button {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: var(--secondary);
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 0.2rem 0.5rem;
        font-size: 0.8rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .terminal-window:hover .copy-button {
        opacity: 1;
    }

    .copy-button:hover {
        background: var(--accent);
        color: var(--bg);
    }

    .table-of-contents {
        background: var(--secondary);
        padding: 1.5rem;
        margin: 2rem 0;
        border-left: 2px solid var(--accent);
    }

    .toc-title {
        color: var(--accent);
        margin-bottom: 1rem;
    }

    .toc-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .toc-item {
        margin-bottom: 0.5rem;
        padding-left: 1rem;
    }

    .toc-item::before {
        content: "→";
        color: var(--accent);
        margin-right: 0.5rem;
    }

    .post-footer {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid var(--secondary);
    }

    .post-nav {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .post-nav-item {
        padding: 1rem;
        background: var(--secondary);
        border-left: 2px solid var(--accent);
    }

    .post-nav-label {
        font-size: 0.8rem;
        color: var(--accent);
        margin-bottom: 0.5rem;
    }

    .post-nav-title {
        font-size: 0.9rem;
    }

    .post-nav-title a {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .post-nav {
            grid-template-columns: 1fr;
        }
    }
</style>


<article class="post">
    <header class="post-header">
        <h1>Monorepos are doo-doo</h1>
        <div class="post-meta">
            <span class="post-meta-item">2024-10-15</span>
            <span class="post-meta-item">Jane Doe</span>
        </div>
        <div class="tags">
            
            <span class="tag">Git</span>
            
            <span class="tag">Best Practices</span>
            
            <span class="tag">Architecture</span>
            
        </div>
    </header>

    <div class="post-content">
        <p>At Bitbucket, we support some of the largest monorepos in existence. Through this experience, we've developed strong opinions about what works and what doesn't. Here's our playbook for scaling monorepos beyond 100GB with thousands of daily contributors.</p>
<h2>Beyond the Monorepo Debate</h2>
<p>First, let's skip the usual monorepo vs. polyrepo debate. If you're reading this, you've likely already chosen the monorepo path. Instead, let's focus on the architectural patterns that make massive monorepos manageable.</p>
<h2>The Three Laws of Large Monorepos</h2>
<p>After analyzing hundreds of large-scale monorepos, we've identified three fundamental laws:</p>
<ol>
<li>Access patterns are never uniform</li>
<li>Tooling requirements grow exponentially with size</li>
<li>Conway's Law is unavoidable - embrace it</li>
</ol>
<p>Let's break these down.</p>
<h2>1. Non-uniform Access Patterns</h2>
<p>Here's a typical access pattern heatmap from one of our enterprise customers:</p>
<pre><code>Repository Structure      │ Access Frequency
────────────────────────────────────────────
/frontend                │ ████████ 80%
  ├── /components       │ ██████   60%
  └── /tests           │ ████     40%
/backend                 │ ███████  70%
  ├── /services        │ ██████   60%
  └── /libraries       │ ███      30%
/tools                   │ ██       20%
/docs                    │ █        10%
</code></pre>
<p>This non-uniform access means we can optimize for hot paths. Here's how:</p>
<pre><code class="language-python">class MonorepoOptimizer:
    def __init__(self, repo_path):
        self.access_patterns = analyze_git_logs(repo_path)
        self.hot_paths = identify_hot_paths(self.access_patterns)
        
    def configure_partial_clone(self):
        return {
            &quot;hot_paths&quot;: self.hot_paths,
            &quot;clone_depth&quot;: calculate_optimal_depth(),
            &quot;prefetch_patterns&quot;: generate_prefetch_rules()
        }
</code></pre>
<h2>2. Tooling Requirements</h2>
<p>As your monorepo grows, you'll need increasingly sophisticated tooling. Here's our toolkit hierarchy:</p>
<h3>Level 1: Basic Hygiene</h3>
<pre><code class="language-bash"># .githooks/pre-commit
#!/bin/bash

# Prevent large binary files
MAX_FILE_SIZE=10485760  # 10MB
files=$(git diff --cached --name-only)

for file in $files; do
    size=$(stat -f%z &quot;$file&quot;)
    if [ &quot;$size&quot; -gt $MAX_FILE_SIZE ]; then
        echo &quot;Error: $file is too large ($size bytes)&quot;
        exit 1
    fi
done
</code></pre>
<h3>Level 2: Smart Caching</h3>
<pre><code class="language-python">class BuildCache:
    def __init__(self):
        self.graph = DependencyGraph()
        self.fingerprints = {}
    
    def should_rebuild(self, path):
        new_hash = self.hash_dependencies(path)
        return new_hash != self.fingerprints.get(path)
</code></pre>
<h3>Level 3: Distributed Execution</h3>
<pre><code class="language-python">class BuildOrchestrator:
    def schedule_builds(self, changes):
        affected = self.graph.get_affected_targets(changes)
        return self.distribute_builds(
            targets=affected,
            workers=self.available_workers,
            priorities=self.calculate_priorities(affected)
        )
</code></pre>
<h2>3. Embracing Conway's Law</h2>
<p>Instead of fighting organizational patterns, build your monorepo structure to match them. Here's our recommended approach:</p>
<pre><code>monorepo/
├── teams/
│   ├── frontend/
│   ├── backend/
│   └── platform/
├── shared/
│   ├── libraries/
│   └── tools/
└── meta/
    ├── docs/
    └── scripts/
</code></pre>
<h2>Implementation: The Virtual Monorepo</h2>
<p>We've developed what we call the &quot;Virtual Monorepo&quot; pattern. It provides the benefits of a monorepo while avoiding the scaling issues:</p>
<pre><code class="language-mermaid">graph TD
    A[Developer] --&gt;|git clone --filter=sparse:path=teams/frontend| B[Virtual Repo]
    B --&gt;|On-demand fetching| C[Physical Monorepo]
    C --&gt;|Intelligent caching| D[Object Store]
    D --&gt;|Distributed across regions| E[Global CDN]
</code></pre>
<h2>Performance Impact</h2>
<p>Here's what we've seen after implementing these patterns:</p>
<pre><code>Metric                  │ Before │ After
─────────────────────────────────────────
Clone time             │ 45m    │ 2m
Disk usage             │ 120GB  │ 8GB
Build time (avg)       │ 35m    │ 12m
Git operation latency  │ 15s    │ 0.8s
</code></pre>
<h2>Anti-patterns to Avoid</h2>
<ol>
<li>
<p><strong>The &quot;Everything is Important&quot; Fallacy</strong></p>
<pre><code class="language-bash"># Don't do this
git clone --full-depth --no-filter
</code></pre>
</li>
<li>
<p><strong>Ignoring Access Patterns</strong></p>
<pre><code class="language-bash"># Don't treat all paths equally
git config core.preloadIndex true  # This helps but isn't enough
</code></pre>
</li>
<li>
<p><strong>Underestimating Tool Requirements</strong></p>
<pre><code class="language-python"># This won't scale
def build_all():
    subprocess.run(['make', 'all'])  # Too simplistic
</code></pre>
</li>
</ol>
<h2>Future Directions</h2>
<p>We're currently working on:</p>
<ol>
<li>ML-powered predictive fetching</li>
<li>Automatic repository layout optimization</li>
<li>Smart branch management for large teams</li>
<li>Distributed build cache with predictive warming</li>
</ol>
<h2>Getting Started</h2>
<p>To implement these patterns in your monorepo:</p>
<ol>
<li>
<p>Install our toolkit:</p>
<pre><code class="language-bash">pip install bitbucket-monorepo-tools
</code></pre>
</li>
<li>
<p>Initialize the optimizer:</p>
<pre><code class="language-bash">bb-monorepo init --analyze
</code></pre>
</li>
<li>
<p>Follow the guided optimization process:</p>
<pre><code class="language-bash">bb-monorepo optimize --adaptive
</code></pre>
</li>
</ol>
<h2>Conclusion</h2>
<p>Managing large monorepos isn't just about having the right tools—it's about understanding and working with your organization's natural development patterns. Stay tuned for our next post where we'll deep dive into our ML-powered predictive fetch system.</p>
<hr />
<p><em>The patterns described here are based on our experience supporting enterprise monorepos at Bitbucket. Every organization is different; adapt these patterns to your specific needs.</em></p>

    </div>

    <footer class="post-footer">
        <div class="terminal-window">
            <div class="terminal-header">
                <span>Share this post</span>
            </div>
            <div class="terminal-body">
                <pre><code>curl  | less</code></pre>
            </div>
        </div>

        <nav class="post-nav">
            

            
        </nav>
    </footer>
</article>

<script>
    // Add copy button to code blocks
    document.querySelectorAll('pre').forEach(block => {
        if (!block.closest('.terminal-window')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';

            button.addEventListener('click', () => {
                navigator.clipboard.writeText(block.textContent);
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });

            const wrapper = document.createElement('div');
            wrapper.className = 'terminal-window';
            block.parentNode.insertBefore(wrapper, block);
            wrapper.appendChild(block);
            wrapper.appendChild(button);
        }
    });

    // Add line numbers to code blocks
    document.querySelectorAll('pre code').forEach(block => {
        const lines = block.textContent.split('\n').length;
        const numbers = document.createElement('div');
        numbers.className = 'line-numbers';
        for (let i = 1; i < lines; i++) {
            numbers.innerHTML += i + '\n';
        }
        block.parentNode.appendChild(numbers);
    });
</script>

    </main>

    <footer>
        <hr>
        <p>Built with <a href="https://github.com/systemsoverload/terminal-velocity">Terminal Velocity</a> | <span class="terminal-cursor"> </span></p>
    </footer>
</body>
</html>
